
  

# AAAS Node-RED Dockerfile

  
This repostory contains the Dockerfile used for building the docker image used in AAAS edge devices.

 
It's platform dependent so there are a Dockerfile for supported hosts:

 - rPI
 - AMD64

  

## Flows

The node-red contains the flows that are included in it.

  
[Node-RED directory](./node-red)
  

## Building and publishing AMD64

  

    docker build --tag=edge-nodered-amd64 --file=latest/Dockerfile .
    
    docker run -it -p 1880:1880 edge-nodered-amd64
    
    docker tag edge-nodered-amd64 rlopezviana/aaas-edge-nodered:[version]-amd64
    
    docker push rlopezviana/aaas-edge-nodered:[version]-amd64

##Building and publishing rPi

For rPI it's required to execute in a rPi.

    docker build --tag=edge-nodered-rpi --file=rpi/Dockerfile .
    docker run -it -p 1880:1880 edge-nodered-rpi
    docker tag edge-nodered-rpi rlopezviana/aaas-edge-nodered:[version]-arm32v7
    docker push rlopezviana/aaas-edge-nodered:[version]-arm32v7

  
Flows incuded

    [{"id":"79b9a330.0a814c","type":"tab","label":"Plant Dashboard","disabled":false,"info":""},{"id":"6fec01e5.9773b","type":"ui_gauge","z":"79b9a330.0a814c","name":"","group":"6df871cd.3f1d3","order":0,"width":0,"height":0,"gtype":"gage","title":"","label":"ºC","format":"{{value}}","min":"-10","max":"60","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1190,"y":480,"wires":[]},{"id":"8552d6e6.a19238","type":"ui_text","z":"79b9a330.0a814c","group":"6df871cd.3f1d3","order":1,"width":0,"height":0,"name":"","label":"ºC","format":"{{msg.payload}}","layout":"col-center","x":1190,"y":440,"wires":[]},{"id":"b455fabe.225b88","type":"ui_chart","z":"79b9a330.0a814c","name":"","group":"6df871cd.3f1d3","order":2,"width":0,"height":0,"label":"","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1190,"y":520,"wires":[[]]},{"id":"6b1a9cb4.d035e4","type":"function","z":"79b9a330.0a814c","name":"humidity","func":"var payload = msg.payload;\nmsg.payload = payload.value;\nmsg.topic = payload.device;\nmsg.timestamp = payload.time.getTime();\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":100,"wires":[["70c53601.e764d8","1b738789.5da8e8","7f016a29.f0db54"]]},{"id":"1b738789.5da8e8","type":"ui_gauge","z":"79b9a330.0a814c","name":"","group":"a29d6a0e.78d878","order":0,"width":0,"height":0,"gtype":"gage","title":"","label":"%","format":"{{value}}","min":"0","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1190,"y":100,"wires":[]},{"id":"70c53601.e764d8","type":"ui_text","z":"79b9a330.0a814c","group":"a29d6a0e.78d878","order":1,"width":0,"height":0,"name":"","label":"%","format":"{{msg.payload}}","layout":"col-center","x":1190,"y":60,"wires":[]},{"id":"7f016a29.f0db54","type":"ui_chart","z":"79b9a330.0a814c","name":"","group":"a29d6a0e.78d878","order":2,"width":0,"height":0,"label":"","chartType":"line","legend":"false","xformat":"D/M","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1190,"y":140,"wires":[[]]},{"id":"48c2388e.c40478","type":"inject","z":"79b9a330.0a814c","name":"","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":false,"onceDelay":"","x":370,"y":540,"wires":[["15ca5644.fc73ca"]]},{"id":"15ca5644.fc73ca","type":"ui_text","z":"79b9a330.0a814c","group":"46c5b713.fad0d8","order":0,"width":"6","height":"1","name":"","label":"","format":"{{payload | date:\"yyyy-MM-dd HH:mm:ss Z\"}}","layout":"col-center","x":590,"y":540,"wires":[]},{"id":"e98a63e1.a0bff","type":"postgres","z":"79b9a330.0a814c","postgresdb":"373da2e6.195dae","name":"Plant telemetry","output":true,"outputs":1,"x":400,"y":280,"wires":[["96725f1.a598ca"]]},{"id":"4975383c.1589c8","type":"function","z":"79b9a330.0a814c","name":"SELECT PLANT TELEMETRY","func":"msg.payload = \"SELECT * FROM telemetry WHERE deviceType = 'PLANT' ORDER BY gwTime DESC\";\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":160,"wires":[["e98a63e1.a0bff"]]},{"id":"3fc73894.617eb8","type":"inject","z":"79b9a330.0a814c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":160,"wires":[["4975383c.1589c8"]]},{"id":"57fb7032.0dfd2","type":"debug","z":"79b9a330.0a814c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":660,"wires":[]},{"id":"96725f1.a598ca","type":"function","z":"79b9a330.0a814c","name":"Unmarshall","func":"var content = msg.payload;\nvar result = [];\nvar processedData = new Map();\nif (Array.isArray(content)) {\n for (var value of content) {\n if (value.data && typeof(value.data) === 'string') {\n let data = JSON.parse(value.data);\n //node.warn(value);\n for (var dataKey of Object.getOwnPropertyNames(data)) {\n let measure = {};\n measure.device = value.device;\n measure.time = new Date(parseInt(value.gwtime));\n measure.value = data[dataKey];\n //node.warn(measure);\n let serie = processedData.get(dataKey);\n if (!serie) {\n serie = [measure];\n processedData.set(dataKey,[]);\n }\n serie.push(measure);\n }\n }\n \n }\n for (var key of processedData.keys()) {\n msg[key]=processedData.get(key);\n }\n \n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":160,"wires":[["c34607ba.1746a8"]]},{"id":"c34607ba.1746a8","type":"function","z":"79b9a330.0a814c","name":"Plant Router","func":"var humidity = null;\nvar sm = null;\nvar light = null;\nvar temperature= null;\n\nif (msg.humidity) {\n humidity = {payload:msg.humidity};\n}\n\nif (msg.light) {\n light = {payload:msg.light};\n}\n\nif (msg.sm) {\n sm = {payload:msg.sm};\n}\n\nif (msg.temperature) {\n light = {payload:msg.temperature};\n}\n\nreturn [humidity, light, sm, temperature];","outputs":4,"noerr":0,"x":630,"y":300,"wires":[["d7c1e72e.68c768"],["f7a87ebd.5f794"],["f8c1aac3.9d36e8"],["8e237703.072668"]]},{"id":"d7c1e72e.68c768","type":"split","z":"79b9a330.0a814c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":830,"y":100,"wires":[["6b1a9cb4.d035e4"]]},{"id":"247285df.0207da","type":"function","z":"79b9a330.0a814c","name":"clean","func":"msg.payload = [];\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":240,"wires":[[]]},{"id":"8ffed6b7.1c6298","type":"inject","z":"79b9a330.0a814c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1380,"y":60,"wires":[["247285df.0207da"]]},{"id":"32effa32.e11d06","type":"ui_gauge","z":"79b9a330.0a814c","name":"","group":"4f8767ed.9227c8","order":0,"width":0,"height":0,"gtype":"gage","title":"","label":"%","format":"{{value}}","min":"0","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1190,"y":360,"wires":[]},{"id":"92dab549.0bfd68","type":"ui_text","z":"79b9a330.0a814c","group":"4f8767ed.9227c8","order":1,"width":0,"height":0,"name":"","label":"%","format":"{{msg.payload}}","layout":"col-center","x":1190,"y":320,"wires":[]},{"id":"8a303254.8029f","type":"ui_chart","z":"79b9a330.0a814c","name":"","group":"4f8767ed.9227c8","order":2,"width":0,"height":0,"label":"","chartType":"line","legend":"false","xformat":"D/M","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1190,"y":400,"wires":[[]]},{"id":"c69245eb.c11788","type":"ui_gauge","z":"79b9a330.0a814c","name":"","group":"46f32890.97ff58","order":0,"width":0,"height":0,"gtype":"gage","title":"","label":"%","format":"{{value}}","min":"0","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1190,"y":240,"wires":[]},{"id":"ec3c7ee9.a1577","type":"ui_text","z":"79b9a330.0a814c","group":"46f32890.97ff58","order":1,"width":0,"height":0,"name":"","label":"%","format":"{{msg.payload}}","layout":"col-center","x":1190,"y":200,"wires":[]},{"id":"ba8f6720.880328","type":"ui_chart","z":"79b9a330.0a814c","name":"","group":"46f32890.97ff58","order":2,"width":0,"height":0,"label":"","chartType":"line","legend":"false","xformat":"D/M","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1190,"y":280,"wires":[[]]},{"id":"65f3c3e1.3fa44c","type":"function","z":"79b9a330.0a814c","name":"light","func":"var payload = msg.payload;\nmsg.payload = payload.value;\nmsg.topic = payload.device;\nmsg.timestamp = payload.time.getTime();\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":240,"wires":[["ec3c7ee9.a1577","c69245eb.c11788","ba8f6720.880328"]]},{"id":"6a5adbe5.118f54","type":"function","z":"79b9a330.0a814c","name":"sm","func":"var payload = msg.payload;\nmsg.payload = payload.value;\nmsg.topic = payload.device;\nmsg.timestamp = payload.time.getTime();\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":360,"wires":[["92dab549.0bfd68","32effa32.e11d06","8a303254.8029f"]]},{"id":"196e2d68.611133","type":"function","z":"79b9a330.0a814c","name":"temperature","func":"var payload = msg.payload;\nmsg.payload = payload.value;\nmsg.topic = payload.device;\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":500,"wires":[["8552d6e6.a19238","6fec01e5.9773b","b455fabe.225b88"]]},{"id":"f7a87ebd.5f794","type":"split","z":"79b9a330.0a814c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":830,"y":240,"wires":[["65f3c3e1.3fa44c"]]},{"id":"f8c1aac3.9d36e8","type":"split","z":"79b9a330.0a814c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":830,"y":360,"wires":[["6a5adbe5.118f54"]]},{"id":"8e237703.072668","type":"split","z":"79b9a330.0a814c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":830,"y":460,"wires":[["196e2d68.611133"]]},{"id":"6df871cd.3f1d3","type":"ui_group","z":"","name":"Temperature","tab":"cd812053.e59dc","order":2,"disp":true,"width":"3","collapse":false},{"id":"a29d6a0e.78d878","type":"ui_group","z":"","name":"Humidity","tab":"cd812053.e59dc","order":3,"disp":true,"width":"3","collapse":false},{"id":"46c5b713.fad0d8","type":"ui_group","z":"","name":"Date/Time","tab":"cd812053.e59dc","order":1,"disp":true,"width":"12","collapse":false},{"id":"373da2e6.195dae","type":"postgresdb","z":"","hostname":"postgres","port":"5432","db":"aaas_db","ssl":false},{"id":"4f8767ed.9227c8","type":"ui_group","z":"","name":"Soil Moisture","tab":"cd812053.e59dc","order":4,"disp":true,"width":"3","collapse":false},{"id":"46f32890.97ff58","type":"ui_group","z":"","name":"Light","tab":"cd812053.e59dc","order":5,"disp":true,"width":"3","collapse":false},{"id":"cd812053.e59dc","type":"ui_tab","z":"","name":"Plants","icon":"dashboard","order":2,"disabled":false,"hidden":false}]

